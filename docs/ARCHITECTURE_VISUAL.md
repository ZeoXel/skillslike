# SkillsLike 架构可视化说明

## 🎯 核心理念

**SkillsLike = 渐进式加载的 Skill 系统**

传统 Agent 一次性加载所有工具 → ❌ 性能差、成本高
SkillsLike 根据意图智能加载 → ✅ 高效、经济

---

## 📊 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                          用户交互层                                    │
│                                                                       │
│  用户浏览器                    管理员                                  │
│      ↓                         ↓                                     │
│  ┌─────────┐             ┌──────────┐                               │
│  │ Web UI  │             │  Skill   │                               │
│  │ (聊天)  │             │ 管理工具  │                               │
│  └─────────┘             └──────────┘                               │
│      │                         │                                     │
│      │ HTTP POST              │ 添加/更新 YAML                       │
│      ▼                         ▼                                     │
└─────────────────────────────────────────────────────────────────────┘
       │                         │
       │                         │
┌──────┼─────────────────────────┼─────────────────────────────────────┐
│      │                         │         FastAPI 服务层               │
│      │                         │                                     │
│      ▼                         ▼                                     │
│  ┌─────────┐             ┌──────────┐                               │
│  │ /api/   │             │ /api/    │                               │
│  │  chat   │             │ skills   │                               │
│  └─────────┘             └──────────┘                               │
│      │                         │                                     │
│      │  接收消息               │  返回 Skill 列表                     │
│      ▼                         │                                     │
└──────┼─────────────────────────┼─────────────────────────────────────┘
       │                         │
       │                         │
┌──────┼─────────────────────────┼─────────────────────────────────────┐
│      │    智能路由层            │                                     │
│      │                         │                                     │
│      ▼                         │                                     │
│  ┌──────────────────┐          │                                     │
│  │  Intent Router   │◄─────────┘                                     │
│  │  意图路由器       │                                                │
│  │                  │                                                │
│  │  1️⃣  提取关键词   │                                                │
│  │  2️⃣  匹配 Skill   │                                                │
│  │  3️⃣  返回候选工具 │                                                │
│  └──────────────────┘                                                │
│      │                                                               │
│      │  选中的 Tools (例如: [image_gen, web_search])                 │
│      ▼                                                               │
└──────┼───────────────────────────────────────────────────────────────┘
       │
       │
┌──────┼───────────────────────────────────────────────────────────────┐
│      │    Agent 核心层 (LangGraph)                                    │
│      │                                                               │
│      ▼                                                               │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                    LangGraph StateGraph                       │   │
│  │                                                               │   │
│  │   ┌─────────┐      ┌─────────┐      ┌──────────┐            │   │
│  │   │  Input  │─────▶│  Agent  │─────▶│  Tools   │            │   │
│  │   │  State  │      │  Node   │      │   Node   │            │   │
│  │   └─────────┘      └─────────┘      └──────────┘            │   │
│  │       │                 │                  │                 │   │
│  │       │                 ▼                  │                 │   │
│  │       │         ┌──────────────┐           │                 │   │
│  │       │         │  LLM 决策    │           │                 │   │
│  │       │         │  调用哪个工具 │           │                 │   │
│  │       │         └──────────────┘           │                 │   │
│  │       │                 │                  │                 │   │
│  │       │                 └──────────────────┘                 │   │
│  │       │                          │                           │   │
│  │       │                          ▼                           │   │
│  │       │                  Tool 执行结果                        │   │
│  │       │                          │                           │   │
│  │       └──────────────────────────┘                           │   │
│  │                                  │                           │   │
│  │                                  ▼                           │   │
│  │                          ┌──────────────┐                    │   │
│  │                          │   Response   │                    │   │
│  │                          └──────────────┘                    │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                  │                                   │
│                                  │  保存对话历史                      │
│                                  ▼                                   │
│                          ┌──────────────┐                            │
│                          │  Checkpoint  │                            │
│                          │  (Memory)    │                            │
│                          └──────────────┘                            │
└──────┬───────────────────────────────────────────────────────────────┘
       │
       │  调用 Executor
       ▼
┌──────────────────────────────────────────────────────────────────────┐
│                        Skill 执行层                                   │
│                                                                       │
│  ┌───────────────┐  ┌───────────────┐  ┌────────────────┐           │
│  │   Anthropic   │  │    Service    │  │     Docker     │           │
│  │   Executor    │  │   Executor    │  │    Executor    │           │
│  │               │  │               │  │                │           │
│  │  调用 Claude  │  │  HTTP API 调用 │  │  容器化执行     │           │
│  │  API 处理任务  │  │  (如图像生成)  │  │  自定义代码     │           │
│  └───────────────┘  └───────────────┘  └────────────────┘           │
│         │                   │                    │                   │
│         └───────────────────┴────────────────────┘                   │
│                             │                                        │
│                             ▼                                        │
│                   ┌──────────────────┐                               │
│                   │  执行结果 + 文件  │                               │
│                   └──────────────────┘                               │
└──────┬────────────────────────────────────────────────────────────────┘
       │
       │  保存生成的文件
       ▼
┌──────────────────────────────────────────────────────────────────────┐
│                        存储层                                         │
│                                                                       │
│  ┌──────────────┐              ┌──────────────┐                      │
│  │  File Store  │              │  State Store │                      │
│  │              │              │              │                      │
│  │  data/files/ │              │ Memory/Redis │                      │
│  │  (图片、文档) │              │ (对话历史)    │                      │
│  └──────────────┘              └──────────────┘                      │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 完整的请求处理流程

### 示例: 用户请求生成图片

```
用户输入: "帮我画一只可爱的橘猫"
           │
           ▼
┌──────────────────────────────────────────┐
│ 步骤 1: 前端发送请求                       │
│                                          │
│ POST /api/chat                           │
│ {                                        │
│   "message": "帮我画一只可爱的橘猫",       │
│   "thread_id": "session-123"             │
│ }                                        │
└──────────────────────────────────────────┘
           │
           ▼
┌──────────────────────────────────────────┐
│ 步骤 2: Intent Router 分析                │
│                                          │
│ 提取关键词: ["画", "橘", "猫"]            │
│                                          │
│ 匹配到 Skills:                            │
│ ✅ nano-banana-image-gen (匹配度: 高)     │
│ ❌ excel-analyzer (匹配度: 低)            │
│ ❌ web-search (匹配度: 低)                │
│                                          │
│ 仅加载: [nano-banana-image-gen]          │
└──────────────────────────────────────────┘
           │
           ▼
┌──────────────────────────────────────────┐
│ 步骤 3: LangGraph Agent 启动              │
│                                          │
│ 创建 StateGraph with:                     │
│ - 1 个工具: nano_banana_image_gen        │
│ - Checkpoint: session-123                │
└──────────────────────────────────────────┘
           │
           ▼
┌──────────────────────────────────────────┐
│ 步骤 4: LLM 决策                          │
│                                          │
│ LLM 分析: "用户想要生成图片"              │
│                                          │
│ 决定调用:                                 │
│ nano_banana_image_gen(                   │
│   prompt="一只可爱的橘猫，毛茸茸的..."    │
│   aspect_ratio="1:1",                    │
│   image_size="4K"                        │
│ )                                        │
└──────────────────────────────────────────┘
           │
           ▼
┌──────────────────────────────────────────┐
│ 步骤 5: ImageGenExecutor 执行             │
│                                          │
│ 1. 读取配置 (API key, endpoint)          │
│ 2. 构建 API 请求                          │
│    POST https://api.bltcy.ai/v1/images/  │
│         generations                      │
│ 3. 等待图片生成 (~20秒)                   │
│ 4. 下载生成的图片                         │
│ 5. 保存到 data/files/xxx.png             │
│ 6. 返回 file_id                           │
└──────────────────────────────────────────┘
           │
           ▼
┌──────────────────────────────────────────┐
│ 步骤 6: Agent 生成回复                     │
│                                          │
│ 基于工具返回结果，LLM 生成友好回复:        │
│                                          │
│ "我已经为你生成了一只可爱的橘猫！🐱       │
│  这只橘猫有着..."                         │
│                                          │
│ 附带: file_id: 5e4ef29b-xxx               │
└──────────────────────────────────────────┘
           │
           ▼
┌──────────────────────────────────────────┐
│ 步骤 7: 返回响应给前端                     │
│                                          │
│ {                                        │
│   "text": "我已经为你生成了...",          │
│   "files": ["5e4ef29b-xxx"],             │
│   "thread_id": "session-123"             │
│ }                                        │
└──────────────────────────────────────────┘
           │
           ▼
┌──────────────────────────────────────────┐
│ 步骤 8: 前端渲染                          │
│                                          │
│ 1. 显示文本消息                           │
│ 2. 检测到 file_id                         │
│ 3. 自动加载图片:                          │
│    <img src="/api/file/5e4ef29b-xxx">    │
│ 4. 用户看到生成的橘猫图片                 │
└──────────────────────────────────────────┘
```

---

## 🎨 Skill 添加流程详解

```
开发者想添加新功能
        │
        ▼
┌────────────────────────┐
│ 创建 Skill Manifest     │
│                        │
│ skills/my-skill.yaml   │
│                        │
│ - name: my-skill       │
│ - description: ...     │
│ - inputs: [...]        │
│ - runtime: ...         │
└────────────────────────┘
        │
        ▼
┌────────────────────────────────────┐
│ 创建 Executor 实现                  │
│                                    │
│ skillslike/executors/              │
│   my_skill_executor.py             │
│                                    │
│ class MySkillInput(BaseModel):     │
│     query: str                     │
│                                    │
│ class MySkillExecutor(BaseExecutor):│
│     def execute(self, query):      │
│         # 自定义逻辑                │
│         return result              │
└────────────────────────────────────┘
        │
        ▼
┌────────────────────────────────────┐
│ 在 Registry 中注册                  │
│                                    │
│ registry.py:                       │
│                                    │
│ if manifest.name == "my-skill":    │
│     executor = MySkillExecutor()   │
│     tool = StructuredTool.from..() │
└────────────────────────────────────┘
        │
        ▼
┌────────────────────────────────────┐
│ 测试 Skill                          │
│                                    │
│ python test_my_skill.py            │
│                                    │
│ 或通过 Web UI 测试                  │
└────────────────────────────────────┘
        │
        ▼
┌────────────────────────────────────┐
│ 重启服务                            │
│                                    │
│ docker-compose restart             │
│ 或                                 │
│ Ctrl+C 然后重新 uvicorn            │
└────────────────────────────────────┘
        │
        ▼
┌────────────────────────────────────┐
│ 用户可以使用新 Skill 了！           │
└────────────────────────────────────┘
```

---

## 🌊 数据流动图

```
┌─────────┐
│  用户   │
└────┬────┘
     │ "帮我画一只猫"
     ▼
┌─────────────┐
│  前端 UI    │
└─────┬───────┘
      │ POST /api/chat
      ▼
┌──────────────────┐
│  FastAPI Server  │
└────┬─────────────┘
     │
     ▼
┌────────────────┐      ┌──────────────┐
│ Intent Router  │─────▶│ Skill Registry│
│ (关键词匹配)    │      │ (加载 YAML)   │
└────┬───────────┘      └──────────────┘
     │
     │ 匹配的工具: [image_gen]
     ▼
┌─────────────────┐
│ LangGraph Agent │
└────┬────────────┘
     │
     ▼
┌──────────────┐       ┌────────────────┐
│  ChatModel   │──────▶│  工具决策      │
│  (Claude)    │       │  使用 image_gen │
└──────────────┘       └────┬───────────┘
                            │
                            ▼
                ┌─────────────────────┐
                │ ImageGenExecutor    │
                └────┬────────────────┘
                     │
                     ▼
        ┌────────────────────────────┐
        │  nano-banana-2 API         │
        │  (图片生成服务)             │
        └────┬───────────────────────┘
             │
             │ 返回图片 URL
             ▼
        ┌──────────────┐
        │ 下载图片      │
        └────┬─────────┘
             │
             ▼
        ┌──────────────┐      ┌──────────────┐
        │ File Store   │◀────▶│ data/files/  │
        │ 保存文件      │      │ xxx.png      │
        └────┬─────────┘      └──────────────┘
             │
             │ file_id: xxx
             ▼
┌────────────────────┐
│ Agent 生成回复     │
│ "我已经生成了..."  │
└────┬───────────────┘
     │
     ▼
┌────────────────┐
│ 返回给前端      │
│ text + files   │
└────┬───────────┘
     │
     ▼
┌────────────────┐
│ 前端渲染图片    │
└────────────────┘
```

---

## 🔑 关键设计原则

### 1. 渐进式加载

**传统方式:**
```python
# 一次性加载所有 100 个工具 ❌
agent = create_agent(all_100_tools)
# → LLM 需要理解所有工具
# → Token 消耗巨大
# → 响应速度慢
```

**SkillsLike 方式:**
```python
# 根据意图只加载 2-3 个相关工具 ✅
relevant_tools = router.route(user_message)
agent = create_agent(relevant_tools)
# → LLM 只需理解少量工具
# → Token 消耗低
# → 响应速度快
```

### 2. 关键词匹配

在 Skill YAML 的 description 中嵌入触发关键词:

```yaml
description: >
  Generate images using AI.
  Triggers: draw, image, picture, paint, create,
            画, 图片, 生成, 绘制, 创建
```

Intent Router 提取用户消息中的关键词:
```
"帮我画一只猫" → ["画", "猫"]
             → 匹配到 image-gen skill
```

### 3. 模块化 Executor

每个 Skill 都是独立的:
- YAML 定义接口
- Executor 实现逻辑
- 互不影响，易于维护

添加新 Skill 不需要修改核心代码！

---

## 📈 扩展性设计

### 水平扩展

```
         ┌──────────┐
         │  Nginx   │  (负载均衡)
         └─────┬────┘
               │
       ┌───────┼───────┐
       │       │       │
       ▼       ▼       ▼
    ┌────┐  ┌────┐  ┌────┐
    │API │  │API │  │API │  (多个实例)
    │ 1  │  │ 2  │  │ 3  │
    └────┘  └────┘  └────┘
       │       │       │
       └───────┼───────┘
               │
               ▼
         ┌──────────┐
         │  Redis   │  (共享状态)
         └──────────┘
```

### 垂直扩展

- 增加 worker 数量
- 使用更强大的服务器
- GPU 加速 (图像生成)

---

## 🎯 总结

**SkillsLike 的核心优势:**

1. ✅ **渐进式加载** - 只加载需要的工具
2. ✅ **模块化设计** - Skill 互不影响
3. ✅ **智能路由** - 自动选择合适的工具
4. ✅ **持久化对话** - 支持多轮对话
5. ✅ **易于扩展** - 添加新 Skill 只需 3 步
6. ✅ **生产就绪** - 完整的部署和监控方案

**适用场景:**

- 🎨 AI 创作助手 (图像、文本、音乐)
- 📊 数据分析平台
- 🔍 智能搜索系统
- 🤖 客服机器人
- 📚 知识管理系统

**开始使用:**

```bash
git clone https://github.com/your-org/skillslike.git
cd skillslike
./deploy.sh dev
```

3分钟即可体验完整功能！
